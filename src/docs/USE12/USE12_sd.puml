@startuml

title US12 - Minimal Backbone Network (Technical Sequence Diagram)

participant MinimalBackboneUI as UI
participant MinimalBackboneController as Controller
participant MinimalBackboneService as Service
participant Graph as InputGraph
participant "Graph\n(MSF)" as MSFGraph
participant GraphvizExporter as Exporter

UI -> Controller : computeMinimalBackbone(railwayGraph)
activate Controller

Controller -> Service : computeMinimalBackbone(graph)
activate Service

Service -> MSFGraph : new MapGraph(false)
activate MSFGraph
deactivate MSFGraph

Service -> InputGraph : vertices()
InputGraph --> Service : ArrayList<RailNode>

loop For each vertex in graph.vertices()
    Service -> MSFGraph : validVertex(vertex)
    MSFGraph --> Service : boolean
    
    alt Vertex NOT in MSF
        Service -> MSFGraph : addVertex(vertex)
        
        loop while expanded == true
            Service -> InputGraph : vertices() from MSF
            
            loop For each vertex in MSF
                Service -> InputGraph : outgoingEdges(vertex)
                InputGraph --> Service : Iterable<Edge<RailNode, RailLine>>
                
                loop For each edge
                    Service -> Service : Get destination vertex
                    Service -> MSFGraph : validVertex(destination)
                    MSFGraph --> Service : boolean
                    
                    alt destination NOT in MSF
                        Service -> Service : Get edge.weight.distance()
                        Service -> Service : Compare with minEdge
                        alt distance < minEdge.distance
                            Service -> Service : Update minEdge = this edge
                        end
                    end
                end
            end
            
            alt minEdge != null
                Service -> MSFGraph : addVertex(minEdge.getVDest())
                Service -> MSFGraph : addEdge(origin, dest, railLine)
                Service -> Service : Set expanded = true
            else minEdge == null
                Service -> Service : Set expanded = false
            end
        end
    end
end

Service --> Controller : MSFGraph (Minimal Spanning Forest)
deactivate Service

Controller -> Exporter : exportUndirectedBackbone(MSFGraph, "minimal_backbone.dot")
activate Exporter

Exporter -> MSFGraph : vertices()
Exporter -> MSFGraph : outgoingEdges(v)

Exporter -> Exporter : Build Graphviz format
Exporter -> Exporter : Write file

Exporter --> Controller : void
deactivate Exporter

Controller --> UI : void (exception handling)
deactivate Controller

UI --> UI : Display success message
UI --> UI : Show command: neato minimal_backbone.dot -Tsvg -o minimal_backbone.svg
UI --> UI : waitReturn()

@enduml
