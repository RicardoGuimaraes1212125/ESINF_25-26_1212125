@startuml

title USEI02 - Prepare Orders for Dispatch

actor "Terminal Operator" as TO
entity "PrepareOrdersUI" as UI
entity "PrepareOrdersController" as CTRL
entity "PrepareOrdersService" as SRV
entity "Warehouse" as WH
entity "Order" as ORD
entity "OrderLine" as LINE
entity "Bay" as BAY
entity "BST<Box>" as TREE
entity "Box" as BOX


TO -> UI: run()
UI -> CTRL: prepareOrders()
CTRL -> SRV: prepareOrders(warehouse)

activate SRV
SRV -> WH: getOrders()
WH --> SRV: List<Order>

SRV -> WH: getAllBays()
WH --> SRV: List<Bay>

note right of SRV
Service prepares currentDate = 2025-09-28
and builds initial inventory map:
Map<SKU, List<Box>>
end note

loop for each Order
    SRV -> ORD: getOrderId(), getDueDate(), getPriority()
    ORD --> SRV: values
    SRV -> ORD: getLines()
    ORD --> SRV: List<OrderLine>

    loop for each OrderLine
        SRV -> LINE: getSku(), getQuantity()
        LINE --> SRV: sku, quantity

        SRV -> WH: getAllBays()
        WH --> SRV: List<Bay>

        loop for each Bay
            SRV -> BAY: getBoxesTree()
            BAY --> SRV: TREE

            SRV -> TREE: inOrder()
            TREE --> SRV: Iterable<Box>

            SRV -> SRV: filter(box.sku == sku)
            SRV -> SRV: filter(expiryDate == null || expiryDate > currentDate)
            SRV -> SRV: add to available list
        end

        alt No boxes found for this SKU
            SRV -> UI: print "No boxes found for SKU: " + sku
            SRV -> SRV: mark line as NOT FULFILLED
        else Boxes available
            SRV -> SRV: sort(availableBoxes by expiryDate, receivedAt) ' FEFO/FIFO order

            SRV -> SRV: qtyPicked = 0
            loop select boxes while qtyPicked < qtyRequired
                SRV -> BOX: getQuantity()
                BOX --> SRV: qty
                SRV -> SRV: qtyPicked += qty
                SRV -> SRV: add box to usedBoxes
            end

            alt Stock sufficient (qtyPicked >= qtyRequired)
                SRV -> SRV: mark line as FULFILLED
                SRV -> UI: print "SKU " + sku + " fulfilled (" + qtyPicked + "/" + qtyRequired + ")"

                loop for each used Box
                    SRV -> BAY: getBoxesTree()
                    BAY --> SRV: TREE
                    SRV -> TREE: remove(box)
                    TREE --> SRV: box removed successfully
                end
            else Stock insufficient (qtyPicked < qtyRequired)
                SRV -> SRV: mark line as PARTIALLY FULFILLED
                SRV -> UI: print "Insufficient stock for SKU " + sku + " (" + qtyPicked + "/" + qtyRequired + ")"
            end

            alt Expired boxes detected
                SRV -> SRV: logWarning("Expired boxes ignored for SKU " + sku)
                SRV -> UI: print "Warning: Some boxes for " + sku + " are expired and were skipped"
            end
        end
    end

    alt All lines fulfilled
        SRV -> SRV: mark order as COMPLETED
        SRV -> UI: print "Order " + orderId + " completed successfully"
    else Some lines not fulfilled
        SRV -> SRV: mark order as PARTIALLY FULFILLED
        SRV -> UI: print "Order " + orderId + " partially completed"
    end
end

SRV -> SRV: summarize results (ordersProcessed, completedOrders, totalBoxesUsed)
SRV -> UI: print dispatch summary report

deactivate SRV
UI -> TO: display "Process finished successfully"

@enduml
